rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Messages collection rules
    match /messages/{messageId} {
      // Allow read access only to authenticated users (including anonymous)
      allow read: if request.auth != null;
      
      // Allow write (create) only to authenticated users
      // Ensure the userId matches the authenticated user
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.text is string
                    && request.resource.data.text.size() > 0
                    && request.resource.data.text.size() <= 1000
                    && request.resource.data.nickname is string
                    && request.resource.data.nickname.size() > 0
                    && request.resource.data.nickname.size() <= 20
                    && request.resource.data.timestamp is number
                    && request.resource.data.createdAt is timestamp;
      
      // Prevent updates and deletes for now (messages are immutable)
      // Future: allow users to delete their own messages
      allow update, delete: if false;
      
      // PLACEHOLDER: Future encryption validation
      // When implementing E2EE, add validation rules:
      // && (!request.resource.data.keys().hasAny(['encrypted']) 
      //     || (request.resource.data.encrypted == true 
      //         && request.resource.data.encryptedContent is string))
    }
    
    // NOTE: User presence/online count is managed in Realtime Database
    // See database.rules.json for presence system rules
    
    // PLACEHOLDER: Future user profiles collection
    // If you want to store user profiles or public keys for E2EE:
    // match /users/{userId} {
    //   allow read: if request.auth != null;
    //   allow write: if request.auth != null && request.auth.uid == userId;
    // }
    
    // PLACEHOLDER: Future encryption keys collection
    // For storing public keys for end-to-end encryption:
    // match /publicKeys/{userId} {
    //   allow read: if request.auth != null;
    //   allow write: if request.auth != null && request.auth.uid == userId;
    // }
    
    // Default deny for all other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
